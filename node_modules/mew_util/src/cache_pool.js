// Cache pool
//
//   -> get(id, autorefresh, generator, timeout)
//   -> put(id, content, timeout)
//   -> refresh(id, timeout)
//   -> clearExpired()
//   -> fetch(filter(id, content)) => [{"id": id, "content": content}]
//

var CachePool = function CachePool(timeout, delegate) {

    var self = this;

    this.timeout = parseInt(timeout);
    if (isNaN(this.timeout)) {
        this.timeout = 20 * 60 * 1000;
    }

    try {
        Object.defineProperty(this, "pool", {
            "enumerable": false,
            "value": {}
        });
    } catch (error) {
        this.pool = {};
    }

    this.delegate = {
        "willReleaseContent": function () {},
        "didClearExpired": function () {}
    };

    if (delegate) {
        Object.keys(delegate).forEach(function(key){
            if (typeof delegate[key] === "function"){
                self.delegate[key] = delegate[key];
            }
        });
    }
};

var define = function (key, value) {
    try {
        Object.defineProperty(CachePool.prototype, key, {
            "enumerable": false,
            "value": value
        });
    } catch (error) {
        CachePool.prototype[key] = value;
    }
};


define("has", function (id) {
    return this.pool.hasOwnProperty(id);
});

CachePool.prototype.working = true;

try {
    Object.defineProperty(CachePool.prototype, "count", {
        "enumerable": true,
        "get": function () {
            return Object.keys(this.pool).length;
        }
    });
} catch (error) {
    // Do nothing
}


define("get", function (id, autorefresh, generator, timeout, listener) {

    if (this.pool.hasOwnProperty(id)) {

        var entry = this.pool[id];

        if (autorefresh) {
            this.refresh(id, timeout);
        }

        return entry.content;

    } else {

        if (generator) {

            var content = generator();

            this.pool[id] = {
                "content": content,
                "listener": listener
            };

            this.refresh(id, timeout);

            return content;

        } else {

            return null;

        }

    }

});

define("fetch", function (filter) {

    return Object.keys(this.pool).filter((function (id) {

        if (filter) {
            return filter(id, this.pool[id].content);
        } else {
            return true;
        }

    }).bind(this)).map((function (id) {

        return {
            "id": id,
            "content": this.pool[id].content
        };

    }).bind(this));

});

define("put", function (id, content, timeout) {


    if (this.pool.hasOwnProperty(id)) {

        if (!timeout) {
            timeout = this.pool[id].timeout;
        }

        this.pool[id].content = content;
        this.pool[id].timeout = timeout;
        this.pool[id].expiredDate = new Date().getTime() + timeout;

    } else {

        if (!timeout) {
            timeout = this.timeout;
        }

        this.pool[id] = {
            "content": content,
            "timeout": timeout,
            "expiredDate": new Date().getTime() + timeout
        };

    }

    this.refresh(id);

});

define("refresh", function (id, timeout) {

    if (this.pool.hasOwnProperty(id)) {

        if (!timeout) {
            timeout = this.pool[id].timeout;
        }

        if (!timeout) {
            timeout = this.timeout;
        }

        this.pool[id].timeout = timeout;
        this.pool[id].expiredDate = new Date().getTime() + timeout;

    }

});

define("clearExpired", function (listener) {

    var now = new Date().getTime();

    var expired = 0;

    Object.keys(this.pool).slice(0).forEach((function (id) {

        if (this.pool[id].expiredDate < now) {

            this.delegate.willReleaseContent.call(this, id, this.pool[id].content);

            if (this.pool[id].listener) {
                this.pool[id].listener(this.pool[id].content);
            }

            expired = expired + 1;

            var deleted = this.pool[id];

            delete this.pool[id];

            if (listener) {
                listener(deleted.expiredDate, deleted.content);
            }

        }

    }).bind(this));

    this.delegate.didClearExpired.call(this, expired);

});

module.exports = CachePool;
